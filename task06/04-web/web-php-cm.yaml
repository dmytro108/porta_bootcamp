apiVersion: v1
data:
  index.php: "<?php\n/**\n * Logger function - writes to stderr (console/Docker logs)\n */\nfunction logDbAction($message) {\n    $timestamp = date('Y-m-d H:i:s');\n    $logMessage = \"[{$timestamp}] {$message}\\n\";\n    \n    // Write to stderr which goes to console/Docker logs, not to the web page\n    file_put_contents('php://stderr', $logMessage);\n}\n\n/**\n * Create database connection\n */\nfunction createDbConnection($host, $dbname, $username, $password, $type) {\n    try {\n        logDbAction(\"Connecting to {$type} server: {$host}\");\n        $pdo = new PDO(\"mysql:host=$host;dbname=$dbname;charset=utf8mb4\", $username, $password);\n        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);\n        logDbAction(\"Successfully connected to {$type} server: {$host}\");\n        return $pdo;\n    } catch (PDOException $e) {\n        logDbAction(\"ERROR: Failed to connect to {$type} server: {$host} - \" . $e->getMessage());\n        die(\"Connection failed: \" . $e->getMessage());\n    }\n}\n\n/**\n * Execute a read query on slave server\n */\nfunction executeReadQuery($pdo_slave, $query, $params = [], $fetchMode = 'all') {\n    logDbAction(\"SLAVE READ: Executing SELECT query on replica server\");\n    $stmt = $pdo_slave->prepare($query);\n    $stmt->execute($params);\n    \n    if ($fetchMode === 'column') {\n        $result = $stmt->fetchColumn();\n    } elseif ($fetchMode === 'all') {\n        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);\n    } else {\n        $result = $stmt;\n    }\n    \n    logDbAction(\"SLAVE READ: Query completed successfully\");\n    return $result;\n}\n\n/**\n * Execute a write query on master server\n */\nfunction executeWriteQuery($pdo_master, $query, $params = []) {\n    logDbAction(\"MASTER WRITE: Executing INSERT/UPDATE query on master server\");\n    $stmt = $pdo_master->prepare($query);\n    $stmt->execute($params);\n    logDbAction(\"MASTER WRITE: Query completed successfully\");\n    return $stmt;\n}\n\n// Database configuration\n$dbname = $_ENV['DB_NAME'];\n$username = $_ENV['DB_USER'];\n$password = $_ENV['DB_PASSWORD'];\n$master_host = $_ENV['DB_WRITE_HOST'];\n$slave_host = $_ENV['DB_READ_HOST'];\n\n// Create separate connections for master (write) and slave (read)\n$pdo_master = createDbConnection($master_host, $dbname, $username, $password, 'MASTER');\n$pdo_slave = createDbConnection($slave_host, $dbname, $username, $password, 'SLAVE');\n\n// Handle form submission for adding new rating\nif (($_POST['action'] ?? '') === 'add_rating') {\n    if (isset($_POST['reviewer_id'], $_POST['movie_id'], $_POST['stars'])) {\n        $reviewer_id = (int)$_POST['reviewer_id'];\n        $movie_id = (int)$_POST['movie_id'];\n        $stars = (int)$_POST['stars'];\n        $ratingDate = !empty($_POST['rating_date']) ? $_POST['rating_date'] : null;\n        \n        // Validate stars range\n        if ($stars < 1 || $stars > 5) {\n            $error_message = \"Stars must be between 1 and 5.\";\n        } else {\n            try {\n                // Check if movie exists (read from slave)\n                $movie_count = executeReadQuery(\n                    $pdo_slave, \n                    \"SELECT COUNT(*) FROM Movie WHERE mID = ?\", \n                    [$movie_id], \n                    'column'\n                );\n                \n                if ($movie_count == 0) {\n                    $error_message = \"Selected movie does not exist.\";\n                } else {\n                    // Check if reviewer exists (read from slave)\n                    $reviewer_count = executeReadQuery(\n                        $pdo_slave, \n                        \"SELECT COUNT(*) FROM Reviewer WHERE rID = ?\", \n                        [$reviewer_id], \n                        'column'\n                    );\n                    \n                    if ($reviewer_count == 0) {\n                        $error_message = \"Selected reviewer does not exist.\";\n                    } else {\n                        // Insert rating (write to master)\n                        executeWriteQuery(\n                            $pdo_master, \n                            \"INSERT INTO Rating (rID, mID, stars, ratingDate) VALUES (?, ?, ?, ?)\",\n                            [$reviewer_id, $movie_id, $stars, $ratingDate]\n                        );\n                        // Redirect to refresh the page and show updated data\n                        header(\"Location: \" . $_SERVER['PHP_SELF'] . \"?success=rating_added\");\n                        exit;\n                    }\n                }\n            } catch (PDOException $e) {\n                logDbAction(\"ERROR: \" . $e->getMessage());\n                $error_message = \"Error adding rating: \" . $e->getMessage();\n            }\n        }\n    } else {\n        $error_message = \"Missing required fields for rating.\";\n    }\n}\n\n// Handle form submission for adding new movie\nif (($_POST['action'] ?? '') === 'add_movie') {\n    if (isset($_POST['movie_id'], $_POST['title'], $_POST['year'])) {\n        $movie_id = (int)$_POST['movie_id'];\n        $title = trim($_POST['title']);\n        $year = (int)$_POST['year'];\n        $director = !empty($_POST['director']) ? trim($_POST['director']) : null;\n        \n        // Validate inputs\n        if (empty($title)) {\n            $error_message = \"Movie title cannot be empty.\";\n        } elseif ($year < 1888 || $year > 2030) {\n            $error_message = \"Year must be between 1888 and 2030.\";\n        } else {\n            try {\n                // Check if movie ID already exists (read from slave)\n                $movie_count = executeReadQuery(\n                    $pdo_slave, \n                    \"SELECT COUNT(*) FROM Movie WHERE mID = ?\", \n                    [$movie_id], \n                    'column'\n                );\n                \n                if ($movie_count > 0) {\n                    $error_message = \"Movie ID already exists. Please use a different ID.\";\n                } else {\n                    // Insert movie (write to master)\n                    executeWriteQuery(\n                        $pdo_master, \n                        \"INSERT INTO Movie (mID, title, year, director) VALUES (?, ?, ?, ?)\",\n                        [$movie_id, $title, $year, $director]\n                    );\n                    // Redirect to refresh the page and show updated data\n                    header(\"Location: \" . $_SERVER['PHP_SELF'] . \"?success=movie_added\");\n                    exit;\n                }\n            } catch (PDOException $e) {\n                logDbAction(\"ERROR: \" . $e->getMessage());\n                $error_message = \"Error adding movie: \" . $e->getMessage();\n            }\n        }\n    } else {\n        $error_message = \"Missing required fields for movie.\";\n    }\n}\n\n// Handle form submission for adding new reviewer\nif (($_POST['action'] ?? '') === 'add_reviewer') {\n    if (isset($_POST['reviewer_id'], $_POST['name'])) {\n        $reviewer_id = (int)$_POST['reviewer_id'];\n        $name = trim($_POST['name']);\n        \n        // Validate inputs\n        if (empty($name)) {\n            $error_message = \"Reviewer name cannot be empty.\";\n        } else {\n            try {\n                // Check if reviewer ID already exists (read from slave)\n                $reviewer_count = executeReadQuery(\n                    $pdo_slave, \n                    \"SELECT COUNT(*) FROM Reviewer WHERE rID = ?\", \n                    [$reviewer_id], \n                    'column'\n                );\n                \n                if ($reviewer_count > 0) {\n                    $error_message = \"Reviewer ID already exists. Please use a different ID.\";\n                } else {\n                    // Insert reviewer (write to master)\n                    executeWriteQuery(\n                        $pdo_master, \n                        \"INSERT INTO Reviewer (rID, name) VALUES (?, ?)\",\n                        [$reviewer_id, $name]\n                    );\n                    // Redirect to refresh the page and show updated data\n                    header(\"Location: \" . $_SERVER['PHP_SELF'] . \"?success=reviewer_added\");\n                    exit;\n                }\n            } catch (PDOException $e) {\n                logDbAction(\"ERROR: \" . $e->getMessage());\n                $error_message = \"Error adding reviewer: \" . $e->getMessage();\n            }\n        }\n    } else {\n        $error_message = \"Missing required fields for reviewer.\";\n    }\n}\n\n// Pagination settings\n$records_per_page = 10;\n$page = isset($_GET['page']) ? (int)$_GET['page'] : 1;\n$offset = ($page - 1) * $records_per_page;\n\n// Get total number of ratings for pagination (read from slave)\nlogDbAction(\"SLAVE READ: Fetching total count of ratings from replica server\");\n$count_stmt = $pdo_slave->query(\"SELECT COUNT(*) FROM Rating r \n                          JOIN Movie m ON r.mID = m.mID \n                          JOIN Reviewer rv ON r.rID = rv.rID\");\n$total_records = $count_stmt->fetchColumn();\n$total_pages = ceil($total_records / $records_per_page);\nlogDbAction(\"SLAVE READ: Found {$total_records} total ratings\");\n\n// Fetch movie ratings with pagination (read from slave)\nlogDbAction(\"SLAVE READ: Fetching ratings page {$page} from replica server\");\n$stmt = $pdo_slave->prepare(\"\n    SELECT \n        m.title, \n        m.year, \n        m.director, \n        rv.name as reviewer_name, \n        r.stars, \n        r.ratingDate \n    FROM Rating r \n    JOIN Movie m ON r.mID = m.mID \n    JOIN Reviewer rv ON r.rID = rv.rID \n    ORDER BY r.ratingDate DESC, m.title ASC \n    LIMIT :limit OFFSET :offset\n\");\n$stmt->bindValue(':limit', $records_per_page, PDO::PARAM_INT);\n$stmt->bindValue(':offset', $offset, PDO::PARAM_INT);\n$stmt->execute();\n$ratings = $stmt->fetchAll(PDO::FETCH_ASSOC);\nlogDbAction(\"SLAVE READ: Retrieved \" . count($ratings) . \" ratings for current page\");\n\n// Get movies and reviewers for dropdowns (read from slave)\n$movies = executeReadQuery($pdo_slave, \"SELECT mID, title FROM Movie ORDER BY title\");\nlogDbAction(\"SLAVE READ: Retrieved \" . count($movies) . \" movies for dropdown\");\n\n$reviewers = executeReadQuery($pdo_slave, \"SELECT rID, name FROM Reviewer ORDER BY name\");\nlogDbAction(\"SLAVE READ: Retrieved \" . count($reviewers) . \" reviewers for dropdown\");\n?>\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Movie Rating System</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }\n        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n        h1, h2 { color: #333; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }\n        th { background-color: #f8f9fa; font-weight: bold; }\n        tr:hover { background-color: #f5f5f5; }\n        .form-section { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }\n        .form-group { margin: 15px 0; }\n        label { display: block; margin-bottom: 5px; font-weight: bold; }\n        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }\n        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }\n        button:hover { background: #0056b3; }\n        .pagination { text-align: center; margin: 20px 0; }\n        .pagination a, .pagination span { display: inline-block; padding: 8px 16px; margin: 0 2px; text-decoration: none; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; }\n        .pagination a:hover { background: #007bff; color: white; }\n        .pagination .current { background: #007bff; color: white; }\n        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }\n        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }\n        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }\n        .tabs { margin: 20px 0; }\n        .tab-button { background: #f8f9fa; border: 1px solid #ddd; padding: 10px 20px; cursor: pointer; margin-right: 5px; border-radius: 4px 4px 0 0; }\n        .tab-button.active { background: #007bff; color: white; }\n        .tab-content { display: none; }\n        .tab-content.active { display: block; }\n    </style>\n    <script>\n        function showTab(tabName) {\n            // Hide all tab contents\n            var contents = document.getElementsByClassName('tab-content');\n            for (var i = 0; i < contents.length; i++) {\n                contents[i].classList.remove('active');\n            }\n            \n            // Remove active class from all buttons\n            var buttons = document.getElementsByClassName('tab-button');\n            for (var i = 0; i < buttons.length; i++) {\n                buttons[i].classList.remove('active');\n            }\n            \n            // Show selected tab and mark button as active\n            document.getElementById(tabName).classList.add('active');\n            event.target.classList.add('active');\n        }\n        \n        // Generate suggested IDs\n        function generateNextId(type) {\n            // This is a simple client-side suggestion\n            // Server-side validation will still check for duplicates\n            var timestamp = new Date().getTime();\n            var random = Math.floor(Math.random() * 1000);\n            \n            if (type === 'movie') {\n                return 100 + (timestamp % 1000) + random % 100;\n            } else if (type === 'reviewer') {\n                return 200 + (timestamp % 1000) + random % 100;\n            }\n        }\n        \n        // Auto-suggest IDs when forms load\n        window.onload = function() {\n            var movieIdField = document.getElementById('movie_id_new');\n            var reviewerIdField = document.getElementById('reviewer_id_new');\n            \n            if (movieIdField && !movieIdField.value) {\n                movieIdField.placeholder = 'Suggested: ' + generateNextId('movie');\n            }\n            \n            if (reviewerIdField && !reviewerIdField.value) {\n                reviewerIdField.placeholder = 'Suggested: ' + generateNextId('reviewer');\n            }\n        }\n    </script>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>\U0001F3AC Movie Rating System</h1>\n        \n        <?php \n        // Handle success messages from URL parameters\n        if (isset($_GET['success'])) {\n            switch ($_GET['success']) {\n                case 'rating_added':\n                    echo '<div class=\"message success\">Rating added successfully!</div>';\n                    break;\n                case 'movie_added':\n                    echo '<div class=\"message success\">Movie added successfully!</div>';\n                    break;\n                case 'reviewer_added':\n                    echo '<div class=\"message success\">Reviewer added successfully!</div>';\n                    break;\n            }\n        }\n        \n        if (isset($success_message)): ?>\n            <div class=\"message success\"><?php echo htmlspecialchars($success_message); ?></div>\n        <?php endif; ?>\n        \n        <?php if (isset($error_message)): ?>\n            <div class=\"message error\"><?php echo htmlspecialchars($error_message); ?></div>\n        <?php endif; ?>\n        \n        <h2>Movie Ratings</h2>\n        <table>\n            <thead>\n                <tr>\n                    <th>Movie Title</th>\n                    <th>Year</th>\n                    <th>Director</th>\n                    <th>Reviewer</th>\n                    <th>Rating</th>\n                    <th>Date</th>\n                </tr>\n            </thead>\n            <tbody>\n                <?php foreach ($ratings as $rating): ?>\n                <tr>\n                    <td><?php echo htmlspecialchars($rating['title']); ?></td>\n                    <td><?php echo htmlspecialchars($rating['year']); ?></td>\n                    <td><?php echo htmlspecialchars($rating['director'] ?: 'Unknown'); ?></td>\n                    <td><?php echo htmlspecialchars($rating['reviewer_name']); ?></td>\n                    <td><?php echo str_repeat('⭐', $rating['stars']); ?> (<?php echo $rating['stars']; ?>/5)</td>\n                    <td><?php echo $rating['ratingDate'] ? htmlspecialchars($rating['ratingDate']) : 'No date'; ?></td>\n                </tr>\n                <?php endforeach; ?>\n            </tbody>\n        </table>\n        \n        <!-- Pagination -->\n        <div class=\"pagination\">\n            <?php if ($page > 1): ?>\n                <a href=\"?page=<?php echo $page - 1; ?>\">« Previous</a>\n            <?php endif; ?>\n            \n            <?php for ($i = 1; $i <= $total_pages; $i++): ?>\n                <?php if ($i == $page): ?>\n                    <span class=\"current\"><?php echo $i; ?></span>\n                <?php else: ?>\n                    <a href=\"?page=<?php echo $i; ?>\"><?php echo $i; ?></a>\n                <?php endif; ?>\n            <?php endfor; ?>\n            \n            <?php if ($page < $total_pages): ?>\n                <a href=\"?page=<?php echo $page + 1; ?>\">Next »</a>\n            <?php endif; ?>\n        </div>\n        \n        <p>Showing page <?php echo $page; ?> of <?php echo $total_pages; ?> (<?php echo $total_records; ?> total ratings)</p>\n        \n        <!-- Add Data Forms -->\n        <h2>Add New Data</h2>\n        <div class=\"tabs\">\n            <button class=\"tab-button active\" onclick=\"showTab('add-rating')\">Add Rating</button>\n            <button class=\"tab-button\" onclick=\"showTab('add-movie')\">Add Movie</button>\n            <button class=\"tab-button\" onclick=\"showTab('add-reviewer')\">Add Reviewer</button>\n        </div>\n        \n        <!-- Add Rating Form -->\n        <div id=\"add-rating\" class=\"tab-content active\">\n            <div class=\"form-section\">\n                <h3>Add New Rating</h3>\n                <form method=\"POST\">\n                    <input type=\"hidden\" name=\"action\" value=\"add_rating\">\n                    \n                    <div class=\"form-group\">\n                        <label for=\"movie_id\">Movie:</label>\n                        <select name=\"movie_id\" id=\"movie_id\" required>\n                            <option value=\"\">Select a movie</option>\n                            <?php foreach ($movies as $movie): ?>\n                                <option value=\"<?php echo $movie['mID']; ?>\">\n                                    <?php echo htmlspecialchars($movie['title']); ?>\n                                </option>\n                            <?php endforeach; ?>\n                        </select>\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"reviewer_id\">Reviewer:</label>\n                        <select name=\"reviewer_id\" id=\"reviewer_id\" required>\n                            <option value=\"\">Select a reviewer</option>\n                            <?php foreach ($reviewers as $reviewer): ?>\n                                <option value=\"<?php echo $reviewer['rID']; ?>\">\n                                    <?php echo htmlspecialchars($reviewer['name']); ?>\n                                </option>\n                            <?php endforeach; ?>\n                        </select>\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"stars\">Rating (1-5 stars):</label>\n                        <select name=\"stars\" id=\"stars\" required>\n                            <option value=\"\">Select rating</option>\n                            <option value=\"1\">1 ⭐</option>\n                            <option value=\"2\">2 ⭐⭐</option>\n                            <option value=\"3\">3 ⭐⭐⭐</option>\n                            <option value=\"4\">4 ⭐⭐⭐⭐</option>\n                            <option value=\"5\">5 ⭐⭐⭐⭐⭐</option>\n                        </select>\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"rating_date\">Rating Date (optional):</label>\n                        <input type=\"date\" name=\"rating_date\" id=\"rating_date\">\n                    </div>\n                    \n                    <button type=\"submit\">Add Rating</button>\n                </form>\n            </div>\n        </div>\n        \n        <!-- Add Movie Form -->\n        <div id=\"add-movie\" class=\"tab-content\">\n            <div class=\"form-section\">\n                <h3>Add New Movie</h3>\n                <form method=\"POST\">\n                    <input type=\"hidden\" name=\"action\" value=\"add_movie\">\n                    \n                    <div class=\"form-group\">\n                        <label for=\"movie_id_new\">Movie ID:</label>\n                        <input type=\"number\" name=\"movie_id\" id=\"movie_id_new\" required min=\"1\">\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"title\">Movie Title:</label>\n                        <input type=\"text\" name=\"title\" id=\"title\" required maxlength=\"255\">\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"year\">Year:</label>\n                        <input type=\"number\" name=\"year\" id=\"year\" required min=\"1888\" max=\"2030\">\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"director\">Director (optional):</label>\n                        <input type=\"text\" name=\"director\" id=\"director\" maxlength=\"255\">\n                    </div>\n                    \n                    <button type=\"submit\">Add Movie</button>\n                </form>\n            </div>\n        </div>\n        \n        <!-- Add Reviewer Form -->\n        <div id=\"add-reviewer\" class=\"tab-content\">\n            <div class=\"form-section\">\n                <h3>Add New Reviewer</h3>\n                <form method=\"POST\">\n                    <input type=\"hidden\" name=\"action\" value=\"add_reviewer\">\n                    \n                    <div class=\"form-group\">\n                        <label for=\"reviewer_id_new\">Reviewer ID:</label>\n                        <input type=\"number\" name=\"reviewer_id\" id=\"reviewer_id_new\" required min=\"1\">\n                    </div>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"name\">Reviewer Name:</label>\n                        <input type=\"text\" name=\"name\" id=\"name\" required maxlength=\"255\">\n                    </div>\n                    \n                    <button type=\"submit\">Add Reviewer</button>\n                </form>\n            </div>\n        </div>\n    </div>\n</body>\n</html>\n"
kind: ConfigMap
metadata:
  labels:
    io.kompose.service: web
  name: web-cm0
  namespace: bootcamp
