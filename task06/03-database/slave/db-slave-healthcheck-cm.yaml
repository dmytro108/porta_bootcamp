apiVersion: v1
data:
  healthcheck.sh: "#!/bin/bash\n\n# Healthcheck script for MySQL slave/replica\n# Checks: 1) Replica is running, 2) No replication errors, 3) Tables are replicated\n\nset -e\n\n# Check replica status\nREPLICA_STATUS=$(mysql -uroot -p\"${MYSQL_ROOT_PASSWORD}\" -e \"SHOW REPLICA STATUS\\G\" 2>/dev/null)\n\nif [ -z \"$REPLICA_STATUS\" ]; then\n  echo \"Healthcheck failed: Unable to get replica status\"\n  exit 1\nfi\n\n# Check if both IO and SQL threads are running\nIO_RUNNING=$(echo \"$REPLICA_STATUS\" | grep \"Replica_IO_Running:\" | awk '{print $2}')\nSQL_RUNNING=$(echo \"$REPLICA_STATUS\" | grep \"Replica_SQL_Running:\" | awk '{print $2}')\n\nif [ \"$IO_RUNNING\" != \"Yes\" ]; then\n  echo \"Healthcheck failed: Replica IO thread not running (IO_Running: $IO_RUNNING)\"\n  exit 1\nfi\n\nif [ \"$SQL_RUNNING\" != \"Yes\" ]; then\n  echo \"Healthcheck failed: Replica SQL thread not running (SQL_Running: $SQL_RUNNING)\"\n  exit 1\nfi\n\n# Check for replication errors\nLAST_IO_ERROR=$(echo \"$REPLICA_STATUS\" | grep \"Last_IO_Error:\" | cut -d: -f2- | xargs)\nLAST_SQL_ERROR=$(echo \"$REPLICA_STATUS\" | grep \"Last_SQL_Error:\" | cut -d: -f2- | xargs)\n\nif [ -n \"$LAST_IO_ERROR\" ] && [ \"$LAST_IO_ERROR\" != \"\" ]; then\n  echo \"Healthcheck failed: Replica IO error: $LAST_IO_ERROR\"\n  exit 1\nfi\n\nif [ -n \"$LAST_SQL_ERROR\" ] && [ \"$LAST_SQL_ERROR\" != \"\" ]; then\n  echo \"Healthcheck failed: Replica SQL error: $LAST_SQL_ERROR\"\n  exit 1\nfi\n\n# Check if tables have been replicated\nTABLES_COUNT=$(mysql -uroot -p\"${MYSQL_ROOT_PASSWORD}\" -sN -e \\\n  \"SELECT COUNT(*) FROM information_schema.tables \n   WHERE table_schema='${MYSQL_DATABASE}' \n   AND table_name IN ('Movie','Reviewer','Rating');\" 2>/dev/null)\n\nif [ \"$TABLES_COUNT\" -ne 3 ]; then\n  echo \"Healthcheck failed: Expected 3 replicated tables, found ${TABLES_COUNT}\"\n  exit 1\nfi\n\necho \"Healthcheck passed: Replica running, no errors, tables replicated\"\nexit 0\n"
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: db-slave
  name: db-slave-cm2
  namespace: bootcamp
