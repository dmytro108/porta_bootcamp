services:
  # Router 1 - OpenVPN Server
  # LAN1 gateway and VPN server endpoint
  router1:
    build:
      context: .
      dockerfile: Dockerfile.router
    container_name: router1
    hostname: router1
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      lan1:
        ipv4_address: 10.10.0.2
      public:
        ipv4_address: 192.168.100.11
    volumes:
      - ./configs/router1/openvpn:/etc/openvpn:ro
      - ./configs/router1/openvpn/ccd:/etc/openvpn/ccd:ro
      - ./configs/router1/network:/etc/network
      - ./scripts:/scripts
    sysctls:
      - net.ipv4.ip_forward=1
    command: ["/bin/bash", "/scripts/router1-entrypoint.sh"]
    restart: unless-stopped

  # Router 2 - OpenVPN Client
  # LAN2 gateway and VPN client endpoint
  router2:
    build:
      context: .
      dockerfile: Dockerfile.router
    container_name: router2
    hostname: router2
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      lan2:
        ipv4_address: 10.20.0.2
      public:
        ipv4_address: 192.168.100.12
    volumes:
      - ./configs/router2/openvpn:/etc/openvpn:ro
      - ./configs/router2/network:/etc/network
      - ./scripts:/scripts
    sysctls:
      - net.ipv4.ip_forward=1
    command: ["/bin/bash", "/scripts/router2-entrypoint.sh"]
    depends_on:
      - router1
    restart: unless-stopped

  # Host 1 - LAN1 client
  # Test host in first LAN
  host1:
    build:
      context: .
      dockerfile: Dockerfile.host
    container_name: host1
    hostname: host1
    cap_add:
      - NET_ADMIN
    networks:
      lan1:
        ipv4_address: 10.10.0.10
    volumes:
      - ./configs/host1/network:/etc/network
      - ./scripts:/scripts
    command: ["/bin/bash", "/scripts/host-entrypoint.sh"]
    depends_on:
      - router1
    restart: unless-stopped

  # Host 2 - LAN2 client
  # Test host in second LAN
  host2:
    build:
      context: .
      dockerfile: Dockerfile.host
    container_name: host2
    hostname: host2
    cap_add:
      - NET_ADMIN
    networks:
      lan2:
        ipv4_address: 10.20.0.10
    volumes:
      - ./configs/host2/network:/etc/network
      - ./scripts:/scripts
    command: ["/bin/bash", "/scripts/host-entrypoint.sh"]
    depends_on:
      - router2
    restart: unless-stopped

networks:
  # LAN 1 - First private network
  lan1:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-lan1

  # LAN 2 - Second private network
  lan2:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.20.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-lan2

  # Public network - Simulates Internet/WAN
  public:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.100.0/24
    driver_opts:
      com.docker.network.bridge.name: br-public
